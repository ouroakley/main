{{ define "main" }}
<style>
/* Base calendar styles */
.calendar,
.calendar-header {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
}

.calendar {
  margin-top: 1rem;
}

.calendar-header {
  font-weight: bold;
  text-align: center;
  background-color: #f4f4f4;
  border-bottom: 1px solid #ddd;
}

.calendar-header div {
  padding: 10px;
}

.calendar-day {
  padding: 10px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-height: 100px;
}

.calendar-day.has-date {
  background-color: #FFFFFF;
  border: 1px solid #ddd;
}

.calendar-day.has-events {
  background-color: #f8f9fa;
}

.calendar-day.empty {
  border: none;
}

.calendar-day .date {
  font-weight: bold;
  margin-bottom: 5px;
}

/* Event styles */
.events {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

.events li {
  margin: 5px 0;
}

.events a {
  text-decoration: none;
  color: #007bff;
}

.events a:hover {
  text-decoration: underline;
}

/* Mobile styles */
@media (max-width: 600px) {
  .calendar {
    display: block;
  }

  .calendar-header {
    display: none;
  }

  .calendar-day {
    display: none;
    padding: 0;
    min-height: 0;
    justify-content: flex-start;
  }

  .calendar-day.has-date {
    background-color: transparent;
    border: none;
  }

  .calendar-day.has-date.has-events {
    display: block;
    margin-bottom: 0.75rem;
  }

  .calendar-day .date {
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
  }

  .calendar-day .date::after {
    content: " - " attr(data-day);
    font-weight: normal;
  }

  .calendar-day .events {
    margin-top: 0;
  }

  .calendar-day .events li {
    margin: 0;
    padding: 0;
  }

  .calendar-day .events a {
    display: block;
    padding: 0.5rem 0;
    line-height: 1.2;
  }

  section.ph4.mb4 {
    margin-bottom: 1rem;
  }

  section.ph4.mb4 h1 {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
  }
}
</style>

<div class="calendar-container mw8 center">
  {{/* Store original context */}}
  {{ $ctx := . }}

  {{/* Always start from current date */}}
  {{ $currentDate := now }}

  {{/* Loop through 12 months */}}
  {{ range $monthIndex := seq 0 12 }}
    {{/* Check if month has any events */}}
    {{ $hasEvents := false }}
    {{ $year := $currentDate.Year }}
    {{ $month := $currentDate.Month }}

    {{/* Check for events in this month */}}
    {{ range $page := $ctx.Site.RegularPages }}
      {{ with $page.Params.eventStart }}
        {{ $eventDate := time . }}
        {{ if and (eq $eventDate.Year $year) (eq $eventDate.Month $month) }}
          {{ $hasEvents = true }}
        {{ end }}
      {{ end }}
    {{ end }}

    <section class="ph4 mb4">
      {{/* Format month name */}}
      <h1 class="mb2">{{ $currentDate.Format "January 2006" }}</h1>
      {{ if not $hasEvents }}
        <p class="mv3 gray i">No events scheduled</p>
      {{ else }}
        {{/* Set up calendar variables */}}
        {{ $dateStr := printf "%04d-%02d-01" $year (int $month) }}
        {{ $firstDay := time $dateStr }}
        {{ $weekday := $firstDay.Weekday }}
        
        {{/* Calculate days in month */}}
        {{ $nextMonth := $firstDay.AddDate 0 1 0 }}
        {{ $lastDay := $nextMonth.AddDate 0 0 -1 }}
        {{ $daysInMonth := $lastDay.Day }}

        <div class="calendar-header">
          <div>Mon</div>
          <div>Tue</div>
          <div>Wed</div>
          <div>Thu</div>
          <div>Fri</div>
          <div>Sat</div>
          <div>Sun</div>
        </div>

        <div class="calendar">
          {{/* Calculate empty cells needed */}}
          {{ $startEmptyCells := 0 }}
          {{ if eq $weekday 0 }}
            {{ $startEmptyCells = 6 }}
          {{ else }}
            {{ $startEmptyCells = sub (int $weekday) 1 }}
          {{ end }}

          {{/* Fill in empty cells */}}
          {{ if gt $startEmptyCells 0 }}
            {{ range $emptyDay := seq 1 $startEmptyCells }}
              <div class="calendar-day empty"></div>
            {{ end }}
          {{ end }}

          {{/* Fill in the days */}}
          {{ range $dayNum := seq 1 $daysInMonth }}
            {{ $dayDate := printf "%04d-%02d-%02d" $year (int $month) $dayNum }}
            {{ $thisDay := time $dayDate }}
            {{ $thisWeekday := $thisDay.Weekday }}
            {{ $displayPosition := 0 }}
            {{ if eq $thisWeekday 0 }}
              {{ $displayPosition = 6 }}
            {{ else }}
              {{ $displayPosition = sub (int $thisWeekday) 1 }}
            {{ end }}
            {{ $gridColumn := add $displayPosition 1 }}

            {{/* Check for events on this specific day */}}
            {{ $eventsToday := slice }}
            {{ range $page := $ctx.Site.RegularPages }}
              {{ with $page.Params.eventStart }}
                {{ $eventDate := time . }}
                {{ if and (eq $eventDate.Year $year) (eq $eventDate.Month $month) (eq $eventDate.Day $dayNum) }}
                  {{ $eventsToday = $eventsToday | append $page }}
                {{ end }}
              {{ end }}
            {{ end }}

            <div class="calendar-day has-date{{ if $eventsToday }} has-events{{ end }}" style="grid-column: {{ $gridColumn }}">
              <div class="date" data-day="{{ $thisDay.Format "Monday" }}">{{ $dayNum }}</div>
              {{ if $eventsToday }}
                <ul class="events">
                  {{ range $event := $eventsToday }}
                    <li><a href="{{ $event.RelPermalink }}">{{ $event.Title }}</a></li>
                  {{ end }}
                </ul>
              {{ end }}
            </div>
          {{ end }}
        </div>
      {{ end }}
    </section>

    {{/* Advance to next month */}}
    {{ $currentDate = $currentDate.AddDate 0 1 0 }}
  {{ end }}
</div>
{{ end }} 